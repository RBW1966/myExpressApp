var socket = null;
var user_id = null;
var terminated = false;
var timer;
var timeout = (function () {
    return function () {
        window.clearTimeout(timer);
        timer = window.setTimeout(() => {
            const m2 = document.getElementById("m");
            m2.placeholder = 'Type a message...';
        }, 5000);
    };
})();
window.addEventListener('load', () => {
    chat_adoIt();
});
// Disable key press
function chat_disableKeyPressing(e) {
    // keycode for F5 function
    if (e.keyCode === 116) {
        e.returnValue = false;
        e.keyCode = 0;
        return false;
    }
    // keycode for Ctrl+R
    if (e.keyCode === 82) {
        if (e.ctrlKey) {
            e.returnValue = false;
            e.keyCode = 0;
            return false;
        }
    }
    // keycode for backspace
    if (e.keyCode === 8) {
        // try to cancel the backspace
        e.returnValue = false;
        e.keyCode = 0;
        return false;
    }
}
function chat_doDisconnect() {
    if (terminated)
        return;
    console.log('doDisconnect');
    alert('Lost connection to myExpressApp.');
    socket.open();
}
function chat_doLogout() {
    terminated = true;
    console.log('doLogout');
    location.href = "/logout";
}
function chat_doRecon() {
    console.log('doRecon');
    socket.close();
}
function chat_doTerminate() {
    terminated = true;
    console.log('doTerminate');
    alert('myExpressApp is offline.');
    location.href = "https://github.com/RBW1966/myExpressApp";
}
function chat_doIncomingChatMessage(message) {
    // Parse the JSON message argument
    var msg = JSON.parse(message);
    // We will display SENDER: MESSAGE
    var msgString = `${msg.sender}: ${msg.msg}`;
    console.log(`INCOMING MESSAGE-${msgString}`);
    // Get the Messages <ul> element
    const messages = document.getElementById("messages");
    // Create the new <li> element
    const newItem = document.createElement("li");
    // Set the <li> inner text
    newItem.appendChild(document.createTextNode(msgString));
    // Append the new <li> to the <ul>
    messages.appendChild(newItem);
    // Scroll to make the new bottom row visible
    messages.scrollTop = messages.scrollHeight - messages.clientHeight;
}
function chat_doConnect() {
    socket.emit('register user', user_id);
}
function chat_adoIt() {
    user_id = chat_getCookie("USER_ID");
    console.log(`myID=${user_id}`);
    socket = io();
    socket.on('terminate', chat_doTerminate);
    socket.on('logout', chat_doLogout);
    socket.on('recon', chat_doRecon);
    socket.on('disconnect', chat_doDisconnect);
    socket.on('chat', chat_doIncomingChatMessage);
    socket.on('connect', chat_doConnect);
    socket.emit('register user', user_id);
    document.getElementById("form1").addEventListener('submit', function (evt) {
        const m = document.getElementById("m");
        evt.preventDefault();
        if (m.value.length) {
            m.placeholder = '';
            let x = timeout();
            socket.emit('chat message', m.value);
            m.value = '';
        }
    });
    document.addEventListener('keydown', (e) => {
        // F5 is pressed
        if ((e.which || e.keyCode) == 116) {
            chat_disableKeyPressing(e);
            console.log('F5 was ignored.');
        }
        // Backspace
        if (e.keyCode == 8) {
            console.log(e.target.id);
            switch (e.target.id) {
                case "m":
                    break;
                default:
                    chat_disableKeyPressing(e);
                    console.log('Backspace was ignored.');
            }
        }
        // Ctrl+R
        if (e.ctrlKey && (e.which === 82)) {
            chat_disableKeyPressing(e);
            console.log('Ctrl+R was ignored.');
        }
    });
}
function chat_getCookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhdC5hcHAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjaGF0LmFwcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUM7QUFDbEIsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDO0FBQ25CLElBQUksVUFBVSxHQUFHLEtBQUssQ0FBQztBQUN2QixJQUFJLEtBQUssQ0FBQztBQUVWLElBQUksT0FBTyxHQUFHLENBQUM7SUFDYixPQUFPO1FBQ0wsTUFBTSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMzQixLQUFLLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBRSxHQUFHLEVBQUU7WUFDOUIsTUFBTSxFQUFFLEdBQXFCLFFBQVEsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDMUQsRUFBRSxDQUFDLFdBQVcsR0FBRyxtQkFBbUIsQ0FBQztRQUN2QyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDWCxDQUFDLENBQUE7QUFDSCxDQUFDLENBQUMsRUFBRSxDQUFDO0FBRUwsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUU7SUFDbkMsVUFBVSxFQUFFLENBQUM7QUFDZixDQUFDLENBQUMsQ0FBQztBQUNILG9CQUFvQjtBQUNwQixTQUFTLHVCQUF1QixDQUFDLENBQUM7SUFDNUIsMEJBQTBCO0lBQzFCLElBQUksQ0FBQyxDQUFDLE9BQU8sS0FBSyxHQUFHLEVBQUU7UUFDckIsQ0FBQyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7UUFDdEIsQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUM7UUFDZCxPQUFPLEtBQUssQ0FBQztLQUNkO0lBQ0QscUJBQXFCO0lBQ3JCLElBQUksQ0FBQyxDQUFDLE9BQU8sS0FBSyxFQUFFLEVBQUU7UUFDcEIsSUFBSSxDQUFDLENBQUMsT0FBTyxFQUFFO1lBQ2IsQ0FBQyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7WUFD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QztLQUNKO0lBQ0QsT0FBTyxFQUFFLENBQUM7QUFDWixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsidmFyIHNvY2tldCA9IG51bGw7XHJcbnZhciB1c2VyX2lkID0gbnVsbDtcclxudmFyIHRlcm1pbmF0ZWQgPSBmYWxzZTtcclxudmFyIHRpbWVyO1xyXG5cclxudmFyIHRpbWVvdXQgPSAoZnVuY3Rpb24gKCkge1xyXG4gIHJldHVybiBmdW5jdGlvbigpIHtcclxuICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGltZXIpO1xyXG4gICAgdGltZXIgPSB3aW5kb3cuc2V0VGltZW91dCggKCkgPT4ge1xyXG4gICAgICBjb25zdCBtMiA9IDxIVE1MSW5wdXRFbGVtZW50PmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwibVwiKTtcclxuICAgICAgbTIucGxhY2Vob2xkZXIgPSAnVHlwZSBhIG1lc3NhZ2UuLi4nO1xyXG4gICAgfSwgNTAwMCk7XHJcbiAgfVxyXG59KSgpO1xyXG5cclxud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCAoKSA9PiB7XHJcbiAgY2hhdF9hZG9JdCgpO1xyXG59KTtcclxuLy8gRGlzYWJsZSBrZXkgcHJlc3NcclxuZnVuY3Rpb24gY2hhdF9kaXNhYmxlS2V5UHJlc3NpbmcoZSkge1xyXG4gICAgICAvLyBrZXljb2RlIGZvciBGNSBmdW5jdGlvblxyXG4gICAgICBpZiAoZS5rZXlDb2RlID09PSAxMTYpIHtcclxuICAgICAgICBlLnJldHVyblZhbHVlID0gZmFsc2U7XHJcbiAgICAgICAgZS5rZXlDb2RlID0gMDtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgLy8ga2V5Y29kZSBmb3IgQ3RybCtSXHJcbiAgICAgIGlmIChlLmtleUNvZGUgPT09IDgyKSB7XHJcbiAgICAgICAgaWYgKGUuY3RybEtleSkge1xyXG4gICAgICAgICAgZS5yZXR1cm5WYWx1ZSA9IGZhbHNlO1xyXG4gICAgICAgICAgZS5rZXlDb2RlID0gMDtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTsgICAgICAgICAgXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIC8vIGtleWNvZGUgZm9yIGJhY2tzcGFjZVxyXG4gICAgICBpZiAoZS5rZXlDb2RlID09PSA4KSB7XHJcbiAgICAgICAgLy8gdHJ5IHRvIGNhbmNlbCB0aGUgYmFja3NwYWNlXHJcbiAgICAgICAgZS5yZXR1cm5WYWx1ZSA9IGZhbHNlO1xyXG4gICAgICAgIGUua2V5Q29kZSA9IDA7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbn1cclxuZnVuY3Rpb24gY2hhdF9kb0Rpc2Nvbm5lY3QoKSB7XHJcbiAgaWYgKHRlcm1pbmF0ZWQpIHJldHVybjtcclxuICBjb25zb2xlLmxvZygnZG9EaXNjb25uZWN0Jyk7XHJcbiAgYWxlcnQoJ0xvc3QgY29ubmVjdGlvbiB0byBteUV4cHJlc3NBcHAuJyk7XHJcbiAgc29ja2V0Lm9wZW4oKTtcclxufVxyXG5mdW5jdGlvbiBjaGF0X2RvTG9nb3V0KCkge1xyXG4gIHRlcm1pbmF0ZWQgPSB0cnVlO1xyXG4gIGNvbnNvbGUubG9nKCdkb0xvZ291dCcpO1xyXG4gIGxvY2F0aW9uLmhyZWYgPSBcIi9sb2dvdXRcIjtcclxufVxyXG5mdW5jdGlvbiBjaGF0X2RvUmVjb24oKSB7XHJcbiAgY29uc29sZS5sb2coJ2RvUmVjb24nKTtcclxuICBzb2NrZXQuY2xvc2UoKTtcclxufVxyXG5mdW5jdGlvbiBjaGF0X2RvVGVybWluYXRlKCkge1xyXG4gIHRlcm1pbmF0ZWQgPSB0cnVlO1xyXG4gIGNvbnNvbGUubG9nKCdkb1Rlcm1pbmF0ZScpO1xyXG4gIGFsZXJ0KCdteUV4cHJlc3NBcHAgaXMgb2ZmbGluZS4nKTtcclxuICBsb2NhdGlvbi5ocmVmID1cImh0dHBzOi8vZ2l0aHViLmNvbS9SQlcxOTY2L215RXhwcmVzc0FwcFwiO1xyXG59XHJcbmZ1bmN0aW9uIGNoYXRfZG9JbmNvbWluZ0NoYXRNZXNzYWdlKG1lc3NhZ2UpIHtcclxuICAvLyBQYXJzZSB0aGUgSlNPTiBtZXNzYWdlIGFyZ3VtZW50XHJcbiAgdmFyIG1zZyA9IEpTT04ucGFyc2UobWVzc2FnZSk7XHJcbiAgLy8gV2Ugd2lsbCBkaXNwbGF5IFNFTkRFUjogTUVTU0FHRVxyXG4gIHZhciBtc2dTdHJpbmcgPSBgJHttc2cuc2VuZGVyfTogJHttc2cubXNnfWBcclxuICBjb25zb2xlLmxvZyhgSU5DT01JTkcgTUVTU0FHRS0ke21zZ1N0cmluZ31gKTtcclxuICAvLyBHZXQgdGhlIE1lc3NhZ2VzIDx1bD4gZWxlbWVudFxyXG4gIGNvbnN0IG1lc3NhZ2VzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJtZXNzYWdlc1wiKTtcclxuICAvLyBDcmVhdGUgdGhlIG5ldyA8bGk+IGVsZW1lbnRcclxuICBjb25zdCBuZXdJdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImxpXCIpO1xyXG4gIC8vIFNldCB0aGUgPGxpPiBpbm5lciB0ZXh0XHJcbiAgbmV3SXRlbS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShtc2dTdHJpbmcpKTtcclxuICAvLyBBcHBlbmQgdGhlIG5ldyA8bGk+IHRvIHRoZSA8dWw+XHJcbiAgbWVzc2FnZXMuYXBwZW5kQ2hpbGQobmV3SXRlbSk7XHJcbiAgLy8gU2Nyb2xsIHRvIG1ha2UgdGhlIG5ldyBib3R0b20gcm93IHZpc2libGVcclxuICBtZXNzYWdlcy5zY3JvbGxUb3AgPSBtZXNzYWdlcy5zY3JvbGxIZWlnaHQgLSBtZXNzYWdlcy5jbGllbnRIZWlnaHQ7XHJcbn1cclxuZnVuY3Rpb24gY2hhdF9kb0Nvbm5lY3QoKSB7XHJcbiAgc29ja2V0LmVtaXQoJ3JlZ2lzdGVyIHVzZXInLCB1c2VyX2lkKTtcclxufVxyXG5mdW5jdGlvbiBjaGF0X2Fkb0l0KCkge1xyXG4gIHVzZXJfaWQgPSBjaGF0X2dldENvb2tpZShcIlVTRVJfSURcIik7XHJcbiAgY29uc29sZS5sb2coYG15SUQ9JHt1c2VyX2lkfWApO1xyXG4gIHNvY2tldCA9IGlvKCk7XHJcbiAgc29ja2V0Lm9uKCd0ZXJtaW5hdGUnLCBjaGF0X2RvVGVybWluYXRlKTtcclxuICBzb2NrZXQub24oJ2xvZ291dCcsIGNoYXRfZG9Mb2dvdXQpO1xyXG4gIHNvY2tldC5vbigncmVjb24nLCBjaGF0X2RvUmVjb24pO1xyXG4gIHNvY2tldC5vbignZGlzY29ubmVjdCcsIGNoYXRfZG9EaXNjb25uZWN0KTtcclxuICBzb2NrZXQub24oJ2NoYXQnLCBjaGF0X2RvSW5jb21pbmdDaGF0TWVzc2FnZSlcclxuICBzb2NrZXQub24oJ2Nvbm5lY3QnLCBjaGF0X2RvQ29ubmVjdCk7XHJcbiAgc29ja2V0LmVtaXQoJ3JlZ2lzdGVyIHVzZXInLCB1c2VyX2lkKTtcclxuICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImZvcm0xXCIpLmFkZEV2ZW50TGlzdGVuZXIoJ3N1Ym1pdCcsIGZ1bmN0aW9uKGV2dCkge1xyXG4gICAgY29uc3QgbSA9IDxIVE1MSW5wdXRFbGVtZW50PmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwibVwiKTtcclxuICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgaWYgKG0udmFsdWUubGVuZ3RoKSB7XHJcbiAgICAgIG0ucGxhY2Vob2xkZXIgPSAnJztcclxuICAgICAgbGV0IHggPSB0aW1lb3V0KCk7XHJcbiAgICAgIHNvY2tldC5lbWl0KCdjaGF0IG1lc3NhZ2UnLCBtLnZhbHVlKTtcclxuICAgICAgbS52YWx1ZSA9ICcnO1xyXG4gICAgfVxyXG4gIH0pO1xyXG4gIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4ge1xyXG4gICAgLy8gRjUgaXMgcHJlc3NlZFxyXG4gICAgaWYoKGUud2hpY2ggfHwgZS5rZXlDb2RlKSA9PSAxMTYpIHtcclxuICAgICAgY2hhdF9kaXNhYmxlS2V5UHJlc3NpbmcoZSk7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdGNSB3YXMgaWdub3JlZC4nKTtcclxuICAgIH1cclxuICAgIC8vIEJhY2tzcGFjZVxyXG4gICAgaWYgKGUua2V5Q29kZSA9PSA4KSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCg8SFRNTElucHV0RWxlbWVudD5lLnRhcmdldCkuaWQpO1xyXG4gICAgICBzd2l0Y2ggKCg8SFRNTElucHV0RWxlbWVudD5lLnRhcmdldCkuaWQpIHtcclxuICAgICAgICBjYXNlIFwibVwiOlxyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgIGNoYXRfZGlzYWJsZUtleVByZXNzaW5nKGUpO1xyXG4gICAgICAgICAgY29uc29sZS5sb2coJ0JhY2tzcGFjZSB3YXMgaWdub3JlZC4nKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8gQ3RybCtSXHJcbiAgICBpZiAoZS5jdHJsS2V5ICYmIChlLndoaWNoID09PSA4MikgKSB7XHJcbiAgICAgIGNoYXRfZGlzYWJsZUtleVByZXNzaW5nKGUpO1xyXG4gICAgICBjb25zb2xlLmxvZygnQ3RybCtSIHdhcyBpZ25vcmVkLicpO1xyXG4gICAgfVxyXG4gIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjaGF0X2dldENvb2tpZShjbmFtZSkge1xyXG4gIHZhciBuYW1lID0gY25hbWUgKyBcIj1cIjtcclxuICB2YXIgZGVjb2RlZENvb2tpZSA9IGRlY29kZVVSSUNvbXBvbmVudChkb2N1bWVudC5jb29raWUpO1xyXG4gIHZhciBjYSA9IGRlY29kZWRDb29raWUuc3BsaXQoJzsnKTtcclxuICBmb3IodmFyIGkgPSAwOyBpIDxjYS5sZW5ndGg7IGkrKykge1xyXG4gICAgICB2YXIgYyA9IGNhW2ldO1xyXG4gICAgICB3aGlsZSAoYy5jaGFyQXQoMCkgPT0gJyAnKSB7XHJcbiAgICAgICAgICBjID0gYy5zdWJzdHJpbmcoMSk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGMuaW5kZXhPZihuYW1lKSA9PSAwKSB7XHJcbiAgICAgICAgICByZXR1cm4gYy5zdWJzdHJpbmcobmFtZS5sZW5ndGgsIGMubGVuZ3RoKTtcclxuICAgICAgfVxyXG4gIH1cclxuICByZXR1cm4gXCJcIjtcclxufSJdfQ==